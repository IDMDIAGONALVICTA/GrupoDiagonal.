<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An√°lise de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        h2 {
            color: #333;
            margin: 40px 0 20px 0;
            font-size: 1.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 3px solid #007C27;
            padding-bottom: 10px;
        }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #F0F5CD;
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .picklist-container {
            position: relative;
        }

        .picklist-selected {
            padding: 10px 15px;
            border: 2px solid #F0F5CD;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            min-height: 42px;
        }

        .picklist-selected:hover {
            border-color: #007C27;
        }

        .picklist-selected.active {
            border-color: #007C27;
            box-shadow: 0 0 0 3px rgba(0, 124, 39, 0.12);
        }

        .picklist-text {
            flex: 1;
            color: #333;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .picklist-text.placeholder {
            color: #999;
        }

        .picklist-arrow { margin-left: 10px; color: #007C27;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .picklist-arrow.open {
            transform: rotate(180deg);
        }

        .picklist-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #007C27;
            border-radius: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .picklist-dropdown.show {
            display: block;
        }

        .picklist-search {
            padding: 10px;
            border-bottom: 1px solid #F0F5CD;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .picklist-search input {
            width: 100%;
            padding: 8px;
            border: 1px solid #F0F5CD;
            border-radius: 4px;
            font-size: 13px;
        }

        .picklist-search input:focus {
            outline: none;
            border-color: #007C27;
        }

        .picklist-options {
            padding: 5px 0;
        }

        .picklist-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .picklist-option:hover { background: #F0F5CD; }

        .picklist-option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .picklist-option label {
            cursor: pointer;
            flex: 1;
            font-weight: normal;
            font-size: 14px;
            margin: 0;
            text-transform: none;
            letter-spacing: normal;
            color: #333;
        }

        .picklist-option.all {
            border-bottom: 1px solid #F0F5CD;
            background: #F0F5CD;
            font-weight: bold;
        }

        .picklist-count { background: #007C27; color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card { background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card h3 { font-size: 1.2em; margin-bottom: 15px; opacity: 1; color: #F0F5CD; text-transform: uppercase; letter-spacing: 1px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value { font-size: 2em; font-weight: bold; margin-top: 10px; color: #F0F5CD; }
            font-weight: bold;
            margin-top: 10px;
        }

        .card.meta { background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
        }

        .card.real { background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
        }

        .card.estoque { background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
        }

        .card.vso { background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
        }

        .button-container {
            text-align: center;
            margin-top: 20px;
        }

        button { background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 124, 39, 0.35);
        }

        button:active {
            transform: scale(0.98);
        }

        .charts-row {
            margin-top: 50px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .chart-section { padding: 30px; background: #F0F5CD;
            border-radius: 15px;
        }

        .chart-section h2 {
            margin-top: 0;
            font-size: 1.4em;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Estilos da Tabela */
	        .table-section { margin-top: 50px; padding: 30px; background: #F0F5CD;
	            border-radius: 15px;
	        }
	        
	        .subtotal-row {
	            font-weight: bold;
	            background-color: #e6ffe6; /* Cor de fundo suave para o subtotal */
	            border-top: 3px solid #007C27;
	        }
	        
	        .subtotal-label {
	            text-align: right;
	            font-size: 1.1em;
	            padding-right: 10px;
	        }
	        
	        .subtotal-value {
	            font-size: 1.1em;
	        }

        .table-controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #F0F5CD;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #007C27;
            box-shadow: 0 0 0 3px rgba(0, 124, 39, 0.12);
        }

        .table-wrapper {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead th {
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        thead th:hover {
            background: rgba(0, 81, 42, 0.10);
        }

        thead th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
            font-size: 12px;
        }

        thead th.sort-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }

        thead th.sort-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #F0F5CD;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #F0F5CD;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody td {
            padding: 12px 10px;
            color: #333;
        }

        tbody td.number {
            text-align: right;
            font-weight: 500;
        }

        tbody td.vso-high { color: #007C27; font-weight: bold; }

        tbody td.vso-medium { color: #00512A; font-weight: bold; }

        tbody td.vso-low { color: #00512A; font-weight: bold; opacity: 0.85; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }

        .export-btn {
            padding: 10px 25px;
            font-size: 14px;
        }

        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.4em;
            }

            .filters-container {
                grid-template-columns: 1fr;
            }

            .cards-container {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 300px;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 12px;
            }

            thead th, tbody td {
                padding: 10px 5px;
            }
        }

        .picklist-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .picklist-dropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .picklist-dropdown::-webkit-scrollbar-thumb { background: #007C27;
            border-radius: 10px;
        }

        .picklist-dropdown::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-wrapper::-webkit-scrollbar-thumb { background: #007C27;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Dashboard de An√°lise de Vendas</h1>
        
        <!-- FILTROS PRINCIPAIS -->
        <div class="filters-container">
            <div class="filter-group">
                <label>Empresa</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="toggleDropdown('empresa')">
                        <span class="picklist-text placeholder" id="empresa-text">Selecione...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="empresa-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterOptions('empresa', this.value)">
                        </div>
                        <div class="picklist-options" id="empresa-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>M√™s</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="toggleDropdown('mes')">
                        <span class="picklist-text placeholder" id="mes-text">Selecione...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="mes-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterOptions('mes', this.value)">
                        </div>
                        <div class="picklist-options" id="mes-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Ano</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="toggleDropdown('ano')">
                        <span class="picklist-text placeholder" id="ano-text">Selecione...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="ano-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterOptions('ano', this.value)">
                        </div>
                        <div class="picklist-options" id="ano-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Linha de Produto</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="toggleDropdown('linha')">
                        <span class="picklist-text placeholder" id="linha-text">Selecione...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="linha-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterOptions('linha', this.value)">
                        </div>
                        <div class="picklist-options" id="linha-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Produto</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="toggleDropdown('produto')">
                        <span class="picklist-text placeholder" id="produto-text">Selecione...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="produto-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterOptions('produto', this.value)">
                        </div>
                        <div class="picklist-options" id="produto-options"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button onclick="applyFilters()">Aplicar Filtros</button>
        </div>

        <!-- CARDS -->
        <div class="cards-container">
            <div class="card meta">
                <h3>Meta VGV</h3>
                <div class="value" id="metaVGV">R$ 0,00</div>
            </div>
            
            <div class="card real">
                <h3>Real VGV</h3>
                <div class="value" id="realVGV">R$ 0,00</div>
            </div>
            
            <div class="card estoque">
                <h3>Estoque VGV</h3>
                <div class="value" id="estoqueVGV">R$ 0,00</div>
            </div>
            
            <div class="card vso">
                <h3>VSO Geral</h3>
                <div class="value" id="vsoGeral">0%</div>
            </div>
        </div>

        <!-- GR√ÅFICOS LADO A LADO -->
        <div class="charts-row">
            <!-- GR√ÅFICO 1: META X REALIZADO -->
            <div class="chart-section">
                <h2>üìà Meta x Realizado</h2>
                
                <div class="filters-container">
                    <div class="filter-group">
                        <label>Ano</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico1-ano')">
                                <span class="picklist-text placeholder" id="grafico1-ano-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico1-ano-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico1-ano', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico1-ano-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>M√™s</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico1-mes')">
                                <span class="picklist-text placeholder" id="grafico1-mes-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico1-mes-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico1-mes', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico1-mes-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Linha de Produto</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico1-linha')">
                                <span class="picklist-text placeholder" id="grafico1-linha-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico1-linha-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico1-linha', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico1-linha-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Produto</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico1-produto')">
                                <span class="picklist-text placeholder" id="grafico1-produto-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico1-produto-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico1-produto', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico1-produto-options"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-container">
                    <button onclick="updateChart1()">Atualizar Gr√°fico</button>
                </div>

                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="chart1"></canvas>
                    </div>
                </div>
            </div>

            <!-- GR√ÅFICO 2: % VSO -->
            <div class="chart-section">
                <h2>üìä % VSO</h2>
                
                <div class="filters-container">
                    <div class="filter-group">
                        <label>Ano</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico2-ano')">
                                <span class="picklist-text placeholder" id="grafico2-ano-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico2-ano-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico2-ano', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico2-ano-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>M√™s</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico2-mes')">
                                <span class="picklist-text placeholder" id="grafico2-mes-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico2-mes-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico2-mes', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico2-mes-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Linha de Produto</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico2-linha')">
                                <span class="picklist-text placeholder" id="grafico2-linha-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico2-linha-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico2-linha', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico2-linha-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Produto</label>
                        <div class="picklist-container">
                            <div class="picklist-selected" onclick="toggleDropdown('grafico2-produto')">
                                <span class="picklist-text placeholder" id="grafico2-produto-text">Selecione...</span>
                                <span class="picklist-arrow">‚ñº</span>
                            </div>
                            <div class="picklist-dropdown" id="grafico2-produto-dropdown">
                                <div class="picklist-search">
                                    <input type="text" placeholder="Buscar..." onkeyup="filterOptions('grafico2-produto', this.value)">
                                </div>
                                <div class="picklist-options" id="grafico2-produto-options"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-container">
                    <button onclick="updateChart2()">Atualizar Gr√°fico</button>
                </div>

                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="chart2"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABELA RESUMO -->
        <div class="table-section">
            <h2>üìã Quadro Resumo</h2>
            
            <div class="table-controls">
                <div class="search-box">
                    <input type="text" id="tableSearch" placeholder="üîç Buscar na tabela..." onkeyup="searchTable()">
                </div>
                <button class="export-btn" onclick="exportToCSV()">üì• Exportar CSV</button>
            </div>

            <div class="table-wrapper">
                <table id="resumoTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(0)">Empresa</th>
                            <th class="sortable" onclick="sortTable(1)">Linha de Produto</th>
                            <th class="sortable" onclick="sortTable(2)">Produto</th>
                            <th class="sortable" onclick="sortTable(3)">Meta VGV</th>
                            <th class="sortable" onclick="sortTable(4)">Real VGV</th>
                            <th class="sortable" onclick="sortTable(5)">Meta QTD</th>
                            <th class="sortable" onclick="sortTable(6)">Estoque VGV</th>
                            <th class="sortable" onclick="sortTable(7)">Estoque QTD</th>
                            <th class="sortable" onclick="sortTable(8)">% VSO</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        
// === IN√çCIO: Carregamento Din√¢mico via Google Sheets (CSV publicado) ===
const SHEETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSju9gP6RC3zHnt5qHlUPuqJMKCqr2TIQ0y7RIhEhGkuUZLGjzKCp6M0kYnqmkLEKJQXNEZycZgCSv6/pub?gid=0&single=true&output=csv";
let csvData = []; // ser√° preenchido ap√≥s o fetch

function csvToArray(text) {
  // Parser simples que respeita aspas
  const rows = [];
  let field = '', row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes) {
      row.push(field);
      field = '';
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && text[i+1] === '\n') { i++; } // CRLF
      row.push(field);
      rows.push(row);
      row = [];
      field = '';
    } else {
      field += c;
    }
  }
  if (field.length > 0 || row.length > 0) {
    row.push(field);
    rows.push(row);
  }
  return rows;
}

function normalizeNumberPtBR(str) {
  if (str == null) return 0;
  str = String(str).trim();
  if (str === '' || str === '-') return 0;
  const cleaned = str.replace(/R\$\s*/g, '').replace(/\./g, '').replace(/\s/g, '').replace(',', '.');
  const v = parseFloat(cleaned);
  return isNaN(v) ? 0 : v;
}

function formatCurrencyPtBR(n) {
  try {
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 2 });
  } catch (e) {
    return 'R$ ' + (Math.round(n*100)/100).toString().replace('.', ',');
  }
}

async function loadGoogleSheetsData() {
  const url = SHEETS_CSV_URL + "&cb=" + Date.now();
  const resp = await fetch(url, { cache: 'no-store' });
  if (!resp.ok) throw new Error("HTTP " + resp.status);
  const text = await resp.text();
  const rows = csvToArray(text);
  if (!rows || rows.length === 0) throw new Error("CSV vazio");
  const header = rows[0].map(h => String(h || '').trim());
  const dataRows = rows.slice(1).filter(r => r.some(x => String(x).trim() !== ''));

  function idx(name) {
    const i = header.findIndex(h => h.toLowerCase() === name.toLowerCase());
    return i >= 0 ? i : -1;
  }
  const col = {
    empresa: idx('empresa'),
    mes: idx('mes'),
    ano: idx('ano'),
    linhaProduto: idx('linhaProduto') >= 0 ? idx('linhaProduto') : idx('linha de produto'),
    produto: idx('produto'),
    metaVGV: idx('metaVGV') >= 0 ? idx('metaVGV') : idx('meta vgv'),
    realVGV: idx('realVGV') >= 0 ? idx('realVGV') : idx('real vgv'),
    metaQtd: idx('metaQtd') >= 0 ? idx('metaQtd') : idx('meta qtd'),
    realQtd: idx('realQtd') >= 0 ? idx('realQtd') : idx('real qtd'),
    estoqueVGV: idx('estoqueVGV') >= 0 ? idx('estoqueVGV') : idx('estoque vgv'),
    estoqueQtd: idx('estoqueQtd') >= 0 ? idx('estoqueQtd') : idx('estoque qtd'),
    vso: idx('vso'),
  };
  csvData = dataRows.map(r => ({
    empresa: col.empresa >= 0 ? r[col.empresa] : '',
    mes: col.mes >= 0 ? r[col.mes] : '',
    ano: col.ano >= 0 ? r[col.ano] : '',
    linhaProduto: col.linhaProduto >= 0 ? r[col.linhaProduto] : '',
    produto: col.produto >= 0 ? r[col.produto] : '',
    metaVGV: col.metaVGV >= 0 ? r[col.metaVGV] : '0',
    realVGV: col.realVGV >= 0 ? r[col.realVGV] : '0',
    metaQtd: col.metaQtd >= 0 ? r[col.metaQtd] : '0',
    realQtd: col.realQtd >= 0 ? r[col.realQtd] : '0',
    estoqueVGV: col.estoqueVGV >= 0 ? r[col.estoqueVGV] : '0',
    estoqueQtd: col.estoqueQtd >= 0 ? r[col.estoqueQtd] : '0',
    vso: col.vso >= 0 ? r[col.vso] : '0%',
  }));

  if (typeof initFiltersAndUI === 'function') {
    initFiltersAndUI();
  } else if (typeof applyFilters === 'function') {
    applyFilters();
  }
}

window.addEventListener('load', () => {
  if (location.protocol === 'file:') {
    console.warn('Abra este HTML por um servidor local (ex: VSCode Live Server) para evitar "Failed to fetch" por CORS do navegador.');
  }
  loadGoogleSheetsData().catch(err => {
    console.error('Erro ao carregar dados da planilha:', err);
    const container = document.querySelector('.container');
    if (container) {
      const div = document.createElement('div');
      div.style.background = '#ffeaea';
      div.style.color = '#b00020';
      div.style.padding = '12px';
      div.style.border = '1px solid #b00020';
      div.style.borderRadius = '8px';
      div.style.marginTop = '12px';
      div.textContent = 'Erro ao carregar dados da planilha: ' + err.message + '. Verifique se est√° abrindo o HTML por http(s) e se a planilha est√° publicada como "Qualquer pessoa com o link".';
      container.prepend(div);
    }
  });
});
// === FIM: Carregamento Din√¢mico via Google Sheets ===

        
        let rawData = [];
        let tableData = [];
        let sortColumn = -1;
        let sortDirection = 'asc';
        
        const mesesOrdem = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        
        const selectedFilters = {
            empresa: [],
            mes: [],
            ano: [],
            linha: [],
            produto: []
        };

        const chart1Filters = {
            ano: [],
            mes: [],
            linha: [],
            produto: []
        };

        const chart2Filters = {
            ano: [],
            mes: [],
            linha: [],
            produto: []
        };

        let chart1Instance = null;
        let chart2Instance = null;

        function parseBRLValue(value) {
            if (!value || value.trim() === '-' || value.trim() === '') return 0;
            
            let cleanValue = value.trim()
                .replace(/\s/g, '')
                .replace(/\./g, '')
                .replace(',', '.');
            
            return parseFloat(cleanValue) || 0;
        }

        function formatBRL(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('pt-BR').format(value);
        }

        function processData() {
            rawData = csvData.map(row => ({
                empresa: row.empresa,
                mes: row.mes,
                ano: row.ano,
                linhaProduto: row.linhaProduto,
                produto: row.produto,
                metaVGV: parseBRLValue(row.metaVGV),
                realVGV: parseBRLValue(row.realVGV),
                metaQtd: parseBRLValue(row.metaQtd),
                realQtd: parseBRLValue(row.realQtd),
                estoqueVGV: parseBRLValue(row.estoqueVGV),
                estoqueQtd: parseBRLValue(row.estoqueQtd),
                vso: row.vso
            }));
            
            populateFilters();
            populateChartFilters();
            applyFilters();
            updateChart1();
            updateChart2();
        }

        function populateFilters() {
            const empresas = [...new Set(rawData.map(r => r.empresa).filter(Boolean))].sort();
            const meses = [...new Set(rawData.map(r => r.mes).filter(Boolean))].sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const anos = [...new Set(rawData.map(r => r.ano).filter(Boolean))].sort();
            const linhas = [...new Set(rawData.map(r => r.linhaProduto).filter(Boolean))].sort();
            const produtos = [...new Set(rawData.map(r => r.produto).filter(Boolean))].sort();
            
            createPicklistOptions('empresa', empresas, 'Todas as Empresas', selectedFilters);
            createPicklistOptions('mes', meses, 'Todos os Meses', selectedFilters);
            createPicklistOptions('ano', anos, 'Todos os Anos', selectedFilters);
            createPicklistOptions('linha', linhas, 'Todas as Linhas', selectedFilters);
            createPicklistOptions('produto', produtos, 'Todos os Produtos', selectedFilters);
        }

        function populateChartFilters() {
            const anos = [...new Set(rawData.map(r => r.ano).filter(Boolean))].sort();
            const meses = [...new Set(rawData.map(r => r.mes).filter(Boolean))].sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const linhas = [...new Set(rawData.map(r => r.linhaProduto).filter(Boolean))].sort();
            const produtos = [...new Set(rawData.map(r => r.produto).filter(Boolean))].sort();
            
            createPicklistOptions('grafico1-ano', anos, 'Todos os Anos', chart1Filters, 'ano');
            createPicklistOptions('grafico1-mes', meses, 'Todos os Meses', chart1Filters, 'mes');
            createPicklistOptions('grafico1-linha', linhas, 'Todas as Linhas', chart1Filters, 'linha');
            createPicklistOptions('grafico1-produto', produtos, 'Todos os Produtos', chart1Filters, 'produto');
            
            createPicklistOptions('grafico2-ano', anos, 'Todos os Anos', chart2Filters, 'ano');
            createPicklistOptions('grafico2-mes', meses, 'Todos os Meses', chart2Filters, 'mes');
            createPicklistOptions('grafico2-linha', linhas, 'Todas as Linhas', chart2Filters, 'linha');
            createPicklistOptions('grafico2-produto', produtos, 'Todos os Produtos', chart2Filters, 'produto');
        }

        function createPicklistOptions(filterId, options, allText, filterObj, filterKey) {
            const container = document.getElementById(`${filterId}-options`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const key = filterKey || filterId;
            
            const allOption = document.createElement('div');
            allOption.className = 'picklist-option all';
            allOption.innerHTML = `
                <input type="checkbox" id="${filterId}-all" onchange="toggleAll('${filterId}', '${key}', ${JSON.stringify(filterObj === selectedFilters)})">
                <label for="${filterId}-all">${allText}</label>
            `;
            container.appendChild(allOption);
            
            options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'picklist-option';
                div.setAttribute('data-value', option.toLowerCase());
                div.innerHTML = `
                    <input type="checkbox" id="${filterId}-${option}" value="${option}" onchange="updateSelection('${filterId}', '${key}', ${JSON.stringify(filterObj === selectedFilters)})">
                    <label for="${filterId}-${option}">${option}</label>
                `;
                container.appendChild(div);
            });
        }

        function toggleDropdown(filterId) {
            const dropdown = document.getElementById(`${filterId}-dropdown`);
            if (!dropdown) return;
            
            const selected = dropdown.previousElementSibling;
            const arrow = selected.querySelector('.picklist-arrow');
            
            document.querySelectorAll('.picklist-dropdown').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    d.previousElementSibling.classList.remove('active');
                    d.previousElementSibling.querySelector('.picklist-arrow').classList.remove('open');
                }
            });
            
            dropdown.classList.toggle('show');
            selected.classList.toggle('active');
            arrow.classList.toggle('open');
        }

        function toggleAll(filterId, filterKey, isMainFilter) {
            const allCheckbox = document.getElementById(`${filterId}-all`);
            const checkboxes = document.querySelectorAll(`#${filterId}-options input[type="checkbox"]:not(#${filterId}-all)`);
            
            checkboxes.forEach(cb => {
                cb.checked = allCheckbox.checked;
            });
            
            updateSelection(filterId, filterKey, isMainFilter);
        }

        function updateSelection(filterId, filterKey, isMainFilter) {
            const checkboxes = document.querySelectorAll(`#${filterId}-options input[type="checkbox"]:not(#${filterId}-all)`);
            const allCheckbox = document.getElementById(`${filterId}-all`);
            const textElement = document.getElementById(`${filterId}-text`);
            
            let filterObj;
            if (isMainFilter) {
                filterObj = selectedFilters;
            } else if (filterId.startsWith('grafico1-')) {
                filterObj = chart1Filters;
            } else if (filterId.startsWith('grafico2-')) {
                filterObj = chart2Filters;
            }
            
            filterObj[filterKey] = [];
            let checkedCount = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    filterObj[filterKey].push(cb.value);
                    checkedCount++;
                }
            });
            
            allCheckbox.checked = checkedCount === checkboxes.length;
            
            if (checkedCount === 0 || checkedCount === checkboxes.length) {
                textElement.textContent = 'Todos';
                textElement.classList.remove('placeholder');
            } else if (checkedCount === 1) {
                textElement.textContent = filterObj[filterKey][0];
                textElement.classList.remove('placeholder');
            } else {
                textElement.innerHTML = `${checkedCount} selecionados <span class="picklist-count">${checkedCount}</span>`;
                textElement.classList.remove('placeholder');
            }
        }

        function filterOptions(filterId, searchText) {
            const options = document.querySelectorAll(`#${filterId}-options .picklist-option:not(.all)`);
            const searchLower = searchText.toLowerCase();
            
            options.forEach(option => {
                const value = option.getAttribute('data-value');
                if (value.includes(searchLower)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.picklist-container')) {
                document.querySelectorAll('.picklist-dropdown').forEach(d => {
                    d.classList.remove('show');
                    d.previousElementSibling.classList.remove('active');
                    d.previousElementSibling.querySelector('.picklist-arrow').classList.remove('open');
                });
            }
        });

        function applyFilters() {
            let filteredData = rawData.filter(row => {
                const matchEmpresa = selectedFilters.empresa.length === 0 || selectedFilters.empresa.includes(row.empresa);
                const matchMes = selectedFilters.mes.length === 0 || selectedFilters.mes.includes(row.mes);
                const matchAno = selectedFilters.ano.length === 0 || selectedFilters.ano.includes(row.ano);
                const matchLinha = selectedFilters.linha.length === 0 || selectedFilters.linha.includes(row.linhaProduto);
                const matchProduto = selectedFilters.produto.length === 0 || selectedFilters.produto.includes(row.produto);
                
                return matchEmpresa && matchMes && matchAno && matchLinha && matchProduto;
            });
            
            const metaTotal = filteredData.reduce((sum, row) => sum + row.metaVGV, 0);
            const realTotal = filteredData.reduce((sum, row) => sum + row.realVGV, 0);
            
            const estoqueTotal = calculateEstoqueVGV(
                selectedFilters.empresa,
                selectedFilters.mes,
                selectedFilters.ano,
                selectedFilters.linha,
                selectedFilters.produto
            );
            
            const vsoGeral = calculateVSOGeral(filteredData);
            
            document.getElementById('metaVGV').textContent = formatBRL(metaTotal);
            document.getElementById('realVGV').textContent = formatBRL(realTotal);
            document.getElementById('estoqueVGV').textContent = formatBRL(estoqueTotal);
            document.getElementById('vsoGeral').textContent = vsoGeral;
            
            // Atualizar tabela
            updateTable(filteredData);
        }

                                function calculateEstoqueVGV(selectedEmpresas, selectedMeses, selectedAnos, selectedLinhas, selectedProdutos) {
            console.log('=== calculateEstoqueVGV ===');
            console.log('Anos selecionados:', selectedAnos);
            console.log('Meses selecionados:', selectedMeses);
            console.log('Empresas selecionadas:', selectedEmpresas);
            
            // REGRA 1: Filtro SOMENTE de ANO (sem filtro de m√™s) - Buscar √∫ltimo m√™s com dados
            if (selectedAnos.length > 0 && selectedMeses.length === 0) {
                console.log('Aplicando REGRA 1: Filtro somente de ANO - Buscando √∫ltimo m√™s com dados');
                let estoqueTotal = 0;
                
                selectedAnos.forEach(ano => {
                    // 1. Encontrar o √∫ltimo m√™s com dados de estoque para o ano atual
                    let ultimoMesComDados = null;
                    for (let i = mesesOrdem.length - 1; i >= 0; i--) {
                        const mes = mesesOrdem[i];
                        const dadosDoMes = rawData.filter(row => {
                            return row.ano === ano && row.mes === mes && row.estoqueVGV > 0;
                        });

                        if (dadosDoMes.length > 0) {
                            ultimoMesComDados = mes;
                            break;
                        }
                    }

                    if (ultimoMesComDados) {
                        console.log(`√öltimo m√™s com dados para ${ano}: ${ultimoMesComDados}`);
                        
                        // 2. Filtrar os dados para o √∫ltimo m√™s encontrado, respeitando outros filtros
                        const dadosUltimoMes = rawData.filter(row => {
                            const matchMes = row.mes === ultimoMesComDados;
                            const matchAno = row.ano === ano;
                            const matchEmpresa = selectedEmpresas.length === 0 || selectedEmpresas.includes(row.empresa);
                            const matchLinha = selectedLinhas.length === 0 || selectedLinhas.includes(row.linhaProduto);
                            const matchProduto = selectedProdutos.length === 0 || selectedProdutos.includes(row.produto);

                            return matchMes && matchAno && matchEmpresa && matchLinha && matchProduto;
                        });

                        // 3. Somar o estoque VGV para este √∫ltimo m√™s
                        estoqueTotal += dadosUltimoMes.reduce((sum, row) => sum + row.estoqueVGV, 0);
                    }
                });
                
                console.log('Estoque Total calculado (Regra 1):', estoqueTotal);
                return estoqueTotal;
            }
            
            // REGRA 2: Quando filtrar M√äS e ANO (apenas 1 m√™s selecionado)
            if (selectedMeses.length === 1) {
                const dadosFiltrados = rawData.filter(row => {
                    const matchMes = selectedMeses.includes(row.mes);
                    const matchAno = selectedAnos.length === 0 || selectedAnos.includes(row.ano);
                    const matchEmpresa = selectedEmpresas.length === 0 || selectedEmpresas.includes(row.empresa);
                    const matchLinha = selectedLinhas.length === 0 || selectedLinhas.includes(row.linhaProduto);
                    const matchProduto = selectedProdutos.length === 0 || selectedProdutos.includes(row.produto);
                    
                    return matchMes && matchAno && matchEmpresa && matchLinha && matchProduto;
                });
                
                return dadosFiltrados.reduce((sum, row) => sum + row.estoqueVGV, 0);
            }
            
            // REGRA 3: Quando filtrar MAIS DE UM M√äS
            if (selectedMeses.length > 1) {
                const mesesOrdenados = [...selectedMeses].sort((a, b) => {
                    return mesesOrdem.indexOf(b) - mesesOrdem.indexOf(a);
                });
                
                const ultimoMesSelecionado = mesesOrdenados[0];
                const indexUltimoMes = mesesOrdem.indexOf(ultimoMesSelecionado);
                
                let mesSubsequente = null;
                if (indexUltimoMes < mesesOrdem.length - 1) {
                    mesSubsequente = mesesOrdem[indexUltimoMes + 1];
                }
                
                if (mesSubsequente) {
                    const dadosMesSubsequente = rawData.filter(row => {
                        const matchMes = row.mes === mesSubsequente;
                        const matchAno = selectedAnos.length === 0 || selectedAnos.includes(row.ano);
                        const matchEmpresa = selectedEmpresas.length === 0 || selectedEmpresas.includes(row.empresa);
                        const matchLinha = selectedLinhas.length === 0 || selectedLinhas.includes(row.linhaProduto);
                        const matchProduto = selectedProdutos.length === 0 || selectedProdutos.includes(row.produto);
                        
                        return matchMes && matchAno && matchEmpresa && matchLinha && matchProduto;
                    });
                    
                    return dadosMesSubsequente.reduce((sum, row) => sum + row.estoqueVGV, 0);
                } else {
                    const dadosUltimoMes = rawData.filter(row => {
                        const matchMes = row.mes === ultimoMesSelecionado;
                        const matchAno = selectedAnos.length === 0 || selectedAnos.includes(row.ano);
                        const matchEmpresa = selectedEmpresas.length === 0 || selectedEmpresas.includes(row.empresa);
                        const matchLinha = selectedLinhas.length === 0 || selectedLinhas.includes(row.linhaProduto);
                        const matchProduto = selectedProdutos.length === 0 || selectedProdutos.includes(row.produto);
                        
                        return matchMes && matchAno && matchEmpresa && matchLinha && matchProduto;
                    });
                    
                    return dadosUltimoMes.reduce((sum, row) => sum + row.estoqueVGV, 0);
                }
            }
            
            // CASO PADR√ÉO: Sem filtro de m√™s ou ano
            const dadosFiltrados = rawData.filter(row => {
                const matchEmpresa = selectedEmpresas.length === 0 || selectedEmpresas.includes(row.empresa);
                const matchLinha = selectedLinhas.length === 0 || selectedLinhas.includes(row.linhaProduto);
                const matchProduto = selectedProdutos.length === 0 || selectedProdutos.includes(row.produto);
                
                return matchEmpresa && matchLinha && matchProduto;
            });
            
            return dadosFiltrados.reduce((sum, row) => sum + row.estoqueVGV, 0);
        }




        function calculateVSOGeral(filteredData) {
            const totalVendas = filteredData.reduce((sum, row) => sum + row.realVGV, 0);
            const totalEstoque = filteredData.reduce((sum, row) => sum + row.estoqueVGV, 0);
            
            if (totalEstoque === 0) return '0%';
            
            const vso = (totalVendas / totalEstoque) * 100;
            return vso.toFixed(2) + '%';
        }

                // ATUALIZAR TABELA - VERS√ÉO COM AGRUPAMENTO E ESTOQUE DO √öLTIMO M√äS
        function updateTable(filteredData) {
            // Verificar se estamos filtrando apenas por ano (sem m√™s espec√≠fico)
            const filtraSomenteAno = selectedFilters.ano.length > 0 && selectedFilters.mes.length === 0;
            
            // Agrupar por Empresa, Linha de Produto e Produto
            const grouped = {};
            
            filteredData.forEach(row => {
                const key = `${row.empresa}|${row.linhaProduto}|${row.produto}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        empresa: row.empresa,
                        linhaProduto: row.linhaProduto,
                        produto: row.produto,
                        metaVGV: 0,
                        realVGV: 0,
                        metaQtd: 0,
                        estoqueVGV: 0,
                        estoqueQtd: 0,
                        registrosPorMes: []
                    };
                }
                
                grouped[key].metaVGV += row.metaVGV;
                grouped[key].realVGV += row.realVGV;
                grouped[key].metaQtd += row.metaQtd;
                grouped[key].estoqueVGV += row.estoqueVGV;
                grouped[key].estoqueQtd += row.estoqueQtd;
                
                grouped[key].registrosPorMes.push({
                    mes: row.mes,
                    estoqueVGV: row.estoqueVGV,
                    estoqueQtd: row.estoqueQtd
                });
            });
            
            // Se filtrar somente por ano, ajustar estoque para o √∫ltimo m√™s
            if (filtraSomenteAno) {
                Object.keys(grouped).forEach(key => {
                    const item = grouped[key];
                    
                    item.registrosPorMes.sort((a, b) => {
                        return mesesOrdem.indexOf(b.mes) - mesesOrdem.indexOf(a.mes);
                    });
                    
                    if (item.registrosPorMes.length > 0) {
                        const ultimoMes = item.registrosPorMes[0];
                        item.estoqueVGV = ultimoMes.estoqueVGV;
                        item.estoqueQtd = ultimoMes.estoqueQtd;
                    }
                });
            }
            
            tableData = Object.values(grouped).map(row => {
                const vsoPercent = row.estoqueVGV > 0 ? ((row.realVGV / row.estoqueVGV) * 100) : 0;
                return {
                    empresa: row.empresa,
                    linhaProduto: row.linhaProduto,
                    produto: row.produto,
                    metaVGV: row.metaVGV,
                    realVGV: row.realVGV,
                    metaQtd: row.metaQtd,
                    estoqueVGV: row.estoqueVGV,
                    estoqueQtd: row.estoqueQtd,
                    vsoPercent: vsoPercent
                };
            });
            
            renderTable();
        }


        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if (tableData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">Nenhum dado encontrado</td></tr>';
                return;
            }
            
            // 1. Calcular Subtotal
            const subtotal = tableData.reduce((acc, row) => {
                acc.metaVGV += row.metaVGV;
                acc.realVGV += row.realVGV;
                acc.metaQtd += row.metaQtd;
                acc.estoqueVGV += row.estoqueVGV;
                acc.estoqueQtd += row.estoqueQtd;
                return acc;
            }, { metaVGV: 0, realVGV: 0, metaQtd: 0, estoqueVGV: 0, estoqueQtd: 0 });
            
            // 2. Calcular VSO do Subtotal (Real VGV / Estoque VGV)
            const subtotalVSO = subtotal.estoqueVGV > 0 ? ((subtotal.realVGV / subtotal.estoqueVGV) * 100) : 0;
            
            // 3. Renderizar linhas de dados
            tableData.forEach(row => {
                const tr = document.createElement('tr');
                
                let vsoClass = '';
                if (row.vsoPercent >= 50) vsoClass = 'vso-high';
                else if (row.vsoPercent >= 20) vsoClass = 'vso-medium';
                else vsoClass = 'vso-low';
                
                tr.innerHTML = `
                    <td>${row.empresa}</td>
                    <td>${row.linhaProduto}</td>
                    <td>${row.produto}</td>
                    <td class="number">${formatBRL(row.metaVGV)}</td>
                    <td class="number">${formatBRL(row.realVGV)}</td>
                    <td class="number">${formatNumber(row.metaQtd)}</td>
                    <td class="number">${formatBRL(row.estoqueVGV)}</td>
                    <td class="number">${formatNumber(row.estoqueQtd)}</td>
                    <td class="number ${vsoClass}">${row.vsoPercent.toFixed(2)}%</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // 4. Renderizar linha de Subtotal
            const trSubtotal = document.createElement('tr');
            trSubtotal.classList.add('subtotal-row');
            
            let subtotalVSOClass = '';
            if (subtotalVSO >= 50) subtotalVSOClass = 'vso-high';
            else if (subtotalVSO >= 20) subtotalVSOClass = 'vso-medium';
            else subtotalVSOClass = 'vso-low';
            
            trSubtotal.innerHTML = `
                <td colspan="3" class="subtotal-label">SUBTOTAL GERAL</td>
                <td class="number subtotal-value">${formatBRL(subtotal.metaVGV)}</td>
                <td class="number subtotal-value">${formatBRL(subtotal.realVGV)}</td>
                <td class="number subtotal-value">${formatNumber(subtotal.metaQtd)}</td>
                <td class="number subtotal-value">${formatBRL(subtotal.estoqueVGV)}</td>
                <td class="number subtotal-value">${formatNumber(subtotal.estoqueQtd)}</td>
                <td class="number subtotal-value ${subtotalVSOClass}">${subtotalVSO.toFixed(2)}%</td>
            `;
            
            tbody.appendChild(trSubtotal);
        }

        function searchTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('resumoTable');
            const headers = table.querySelectorAll('th');
            
            // Resetar outros headers
            headers.forEach((header, index) => {
                if (index !== columnIndex) {
                    header.classList.remove('sort-asc', 'sort-desc');
                }
            });
            
            // Toggle dire√ß√£o
            if (sortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIndex;
                sortDirection = 'asc';
            }
            
            // Atualizar visual do header
            headers[columnIndex].classList.remove('sort-asc', 'sort-desc');
            headers[columnIndex].classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Ordenar dados
            tableData.sort((a, b) => {
                let valA, valB;
                
                switch(columnIndex) {
                    case 0: valA = a.empresa; valB = b.empresa; break;
                    case 1: valA = a.linhaProduto; valB = b.linhaProduto; break;
                    case 2: valA = a.produto; valB = b.produto; break;
                    case 3: valA = a.metaVGV; valB = b.metaVGV; break;
                    case 4: valA = a.realVGV; valB = b.realVGV; break;
                    case 5: valA = a.metaQtd; valB = b.metaQtd; break;
                    case 6: valA = a.estoqueVGV; valB = b.estoqueVGV; break;
                    case 7: valA = a.estoqueQtd; valB = b.estoqueQtd; break;
                    case 8: valA = a.vsoPercent; valB = b.vsoPercent; break;
                    default: return 0;
                }
                
                if (typeof valA === 'string') {
                    return sortDirection === 'asc' ? 
                        valA.localeCompare(valB) : 
                        valB.localeCompare(valA);
                } else {
                    return sortDirection === 'asc' ? 
                        valA - valB : 
                        valB - valA;
                }
            });
            
            renderTable();
        }

        function exportToCSV() {
            let csv = 'Empresa;Linha de Produto;Produto;Meta VGV;Real VGV;Meta QTD;Estoque VGV;Estoque QTD;% VSO\n';
            
            tableData.forEach(row => {
                csv += `${row.empresa};${row.linhaProduto};${row.produto};`;
                csv += `${row.metaVGV.toFixed(2)};${row.realVGV.toFixed(2)};${row.metaQtd};`;
                csv += `${row.estoqueVGV.toFixed(2)};${row.estoqueQtd};${row.vsoPercent.toFixed(2)}%\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'quadro_resumo.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // GR√ÅFICO 1: META X REALIZADO (BARRAS)
        function updateChart1() {
            const filteredData = rawData.filter(row => {
                const matchAno = chart1Filters.ano.length === 0 || chart1Filters.ano.includes(row.ano);
                const matchMes = chart1Filters.mes.length === 0 || chart1Filters.mes.includes(row.mes);
                const matchLinha = chart1Filters.linha.length === 0 || chart1Filters.linha.includes(row.linhaProduto);
                const matchProduto = chart1Filters.produto.length === 0 || chart1Filters.produto.includes(row.produto);
                
                return matchAno && matchMes && matchLinha && matchProduto;
            });

            const dataByMonth = {};
            filteredData.forEach(row => {
                if (!dataByMonth[row.mes]) {
                    dataByMonth[row.mes] = { meta: 0, real: 0 };
                }
                dataByMonth[row.mes].meta += row.metaVGV;
                dataByMonth[row.mes].real += row.realVGV;
            });

            const labels = Object.keys(dataByMonth).sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const metaData = labels.map(mes => dataByMonth[mes].meta);
            const realData = labels.map(mes => dataByMonth[mes].real);

            const ctx = document.getElementById('chart1');
            
            if (chart1Instance) {
                chart1Instance.destroy();
            }

            chart1Instance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Meta VGV', backgroundColor: '#00512A', borderColor: '#00512A', borderWidth: 1,      
                            data: metaData,
                            
                            
                            },
                        {
                            label: 'Realizado VGV', backgroundColor: '#007C27', borderColor: '#007C27', borderWidth: 1,      
                            data: realData,
                            
                            
                            }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Meta x Realizado (VGV)',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatBRL(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // GR√ÅFICO 2: % VSO (BARRAS)
        function updateChart2() {
            const filteredData = rawData.filter(row => {
                const matchAno = chart2Filters.ano.length === 0 || chart2Filters.ano.includes(row.ano);
                const matchMes = chart2Filters.mes.length === 0 || chart2Filters.mes.includes(row.mes);
                const matchLinha = chart2Filters.linha.length === 0 || chart2Filters.linha.includes(row.linhaProduto);
                const matchProduto = chart2Filters.produto.length === 0 || chart2Filters.produto.includes(row.produto);
                
                return matchAno && matchMes && matchLinha && matchProduto;
            });

            const dataByMonth = {};
            filteredData.forEach(row => {
                if (!dataByMonth[row.mes]) {
                    dataByMonth[row.mes] = { vendas: 0, estoque: 0 };
                }
                dataByMonth[row.mes].vendas += row.realVGV;
                dataByMonth[row.mes].estoque += row.estoqueVGV;
            });

            const labels = Object.keys(dataByMonth).sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const vsoData = labels.map(mes => {
                const data = dataByMonth[mes];
                if (data.estoque === 0) return 0;
                return ((data.vendas / data.estoque) * 100).toFixed(2);
            });

            const ctx = document.getElementById('chart2');
            
            if (chart2Instance) {
                chart2Instance.destroy();
            }

            chart2Instance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '% VSO', backgroundColor: '#007C27', borderColor: '#00512A', borderWidth: 1,   
                            data: vsoData,
                            
                            
                            }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Percentual de VSO por M√™s',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'VSO: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        window.addEventListener('load', processData);
    </script>

<script>
(function() {
  try {
    if (window.Chart) {
      Chart.defaults.elements = Chart.defaults.elements || {}
      Chart.defaults.elements.bar = Chart.defaults.elements.bar || {}
      Chart.defaults.elements.bar.backgroundColor = '#007C27';
      Chart.defaults.elements.bar.borderColor = '#007C27';
      Chart.defaults.elements.bar.borderWidth = 1;
      Chart.defaults.color = '#00512A';
    }
  } catch(e) { }
})();
</script>
</body>
</html>
